var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var network = require('../network');
var trainer = require('../trainer');
var Layer = require('../layer');
var MemoryTape = (function () {
    function MemoryTape(memoryBlocks, layer, inputGate, forgetGate) {
        var _this = this;
        this.memoryAttentionLocation = 0;
        this.memoryAttentionWeight = 0;
        this.blocks = memoryBlocks;
        this.data = new Array(memoryBlocks);
        this.blockWidth = layer.list.length;
        this.layer = layer;
        for (var location = 0; location < this.blocks; location++) {
            var array = this.data[location] = new Float64Array(this.blockWidth);
            for (var i = 0; i < array.length; i++) {
                array[i] = 0.1 * Math.random();
            }
        }
        // Hack the layer!
        this.prevLayerActivate = this.layer.activate.bind(this.layer);
        this.layer.activate = function (input) {
            var key = _this.prevLayerActivate(input);
            var addGate = inputGate.currentActivation;
            var eraseGate = forgetGate.currentActivation;
            var similarAddresses = _this.getSimilarAdresses(key);
            // elegible memblocks for read/write operations
            var elegibleIndexes = [0, 1, 2];
            var elegibleWeights = [0.2, 0.6, 0.2]; // shifting, softmax
            var focus = 1;
            _this.memoryAttentionWeight = 0;
            for (var address = 0; address < similarAddresses.length; address++) {
                var ß = similarAddresses[address];
                if (ß > _this.memoryAttentionWeight) {
                    _this.memoryAttentionWeight = ß;
                    _this.memoryAttentionLocation = address;
                }
            }
            elegibleIndexes = [_this.memoryAttentionLocation - 1, _this.memoryAttentionLocation, _this.memoryAttentionLocation + 1];
            focus = _this.memoryAttentionWeight;
            for (var n = 0; n < elegibleIndexes.length; n++) {
                var index = elegibleIndexes[n];
                if (index < 0)
                    index += similarAddresses.length;
                else if (index >= similarAddresses.length)
                    index -= similarAddresses.length;
                elegibleIndexes[n] = index;
                elegibleWeights[n] = Math.pow(elegibleWeights[n], focus);
                var M = _this.data[index];
                for (var i = 0; i < M.length; i++) {
                    // do erase operations on the memory tape. NTM: 3.2 (3)
                    M[i] *= 1 - eraseGate[i] * key[i] * elegibleWeights[n];
                    // do add operations on the memory tape. NTM: 3.2 (4)
                    M[i] += addGate[i] * key[i] * elegibleWeights[n];
                }
            }
            layer.list.forEach(function (neuron, i) {
                // modify the current key (readVector)
                var tmpKey = 0;
                for (var n = 0; n < elegibleIndexes.length; n++) {
                    tmpKey += _this.data[elegibleIndexes[n]][i] * elegibleWeights[n];
                }
                // write activation value back into each neuron, also squash it on the key vector      
                neuron.derivative = neuron.squash(tmpKey, true);
                neuron.activation = key[i] = neuron.squash(tmpKey, false);
            });
            return key;
        };
    }
    MemoryTape.getSimilarity = function (arrayA, arrayB) {
        // http://en.wikipedia.org/wiki/Cosine_similarity
        // NTM: 3.3.1 (6)
        var dotPr = 0;
        var acumA = 0, acumB = 0;
        for (var i = 0; i < arrayA.length; i++) {
            dotPr += arrayA[i] * arrayB[i];
            acumA += arrayA[i] * arrayA[i];
            acumB += arrayB[i] * arrayB[i];
        }
        return dotPr / (Math.sqrt(acumA) * Math.sqrt(acumB) + .00005);
    };
    MemoryTape.softMaxArray = function (array, sharpen) {
        // for all i ∈ array
        // sum = ∑ array[n]^e
        // i = î^e / sum
        // where the result ∑ array[0..n] = 1
        if (sharpen === void 0) { sharpen = 1; }
        if (!array.length)
            return array;
        sharpen = sharpen || 1;
        var sum = 0;
        for (var i = 0; i < array.length; i++) {
            array[i] = Math.exp(sharpen * array[i]);
            sum += array[i];
        }
        if (sum != 0) {
            for (var i = 0; i < array.length; i++)
                array[i] /= sum;
        }
        else {
            var div = 1 / array.length;
            for (var i = 0; i < array.length; i++)
                array[i] = div;
        }
        return array;
    };
    // obtains an array of similarity indexes for each memoryBlock
    MemoryTape.prototype.getSimilarAdresses = function (weights) {
        //checkpoint: 10th cigarret
        var addresses = new Float64Array(this.data.length);
        for (var i = 0; i < this.data.length; i++)
            addresses[i] = MemoryTape.getSimilarity(this.data[i], weights);
        return addresses;
    };
    return MemoryTape;
})();
exports.MemoryTape = MemoryTape;
var MemoryBlock = (function (_super) {
    __extends(MemoryBlock, _super);
    function MemoryBlock(inputSize, memoryBlocks, memoryWidth, outputSize) {
        // DO NOT OPTIMIZE THIS NETWORK
        this.optimized = false;
        var option = {
            peepholes: Layer.Layer.connectionType.ALL_TO_ALL,
            hiddentohidden: false,
            outtohidden: false,
            outtogates: false,
            intoout: true,
        };
        var inputLayer = new Layer.Layer(inputSize);
        var hiddenLayers = [];
        var outputLayer = new Layer.Layer(outputSize);
        //#region generate layers
        // generate memory blocks (memory cell and respective gates)
        var inputGate = new Layer.Layer(memoryWidth).set({
            bias: 1
        });
        var forgetGate = new Layer.Layer(memoryWidth).set({
            bias: 1
        });
        var memoryCell = new Layer.Layer(memoryWidth);
        var outputGate = new Layer.Layer(memoryWidth).set({
            bias: 1
        });
        hiddenLayers.push(inputGate);
        hiddenLayers.push(forgetGate);
        hiddenLayers.push(memoryCell);
        hiddenLayers.push(outputGate);
        // connections from input layer
        var input = inputLayer.project(memoryCell);
        inputLayer.project(inputGate);
        inputLayer.project(forgetGate);
        inputLayer.project(outputGate);
        // connections from memory cell
        var output = memoryCell.project(outputLayer);
        // self-connection
        var self = memoryCell.project(memoryCell);
        // peepholes
        memoryCell.project(inputGate, option.peepholes);
        memoryCell.project(forgetGate, option.peepholes);
        memoryCell.project(outputGate, option.peepholes);
        // gates
        inputGate.gate(input, Layer.Layer.gateType.INPUT);
        forgetGate.gate(self, Layer.Layer.gateType.ONE_TO_ONE);
        outputGate.gate(output, Layer.Layer.gateType.OUTPUT);
        this.memoryTape = new MemoryTape(memoryBlocks, memoryCell, inputGate, forgetGate);
        //#endregion
        // input to output direct connection
        if (option.intoout)
            inputLayer.project(outputLayer);
        // set the layers of the neural network
        _super.call(this, {
            input: inputLayer,
            hidden: hiddenLayers,
            output: outputLayer
        });
        // trainer
        this.trainer = new trainer.Trainer(this);
    }
    return MemoryBlock;
})(network.Network);
exports.MemoryBlock = MemoryBlock;
;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9hcmNoaXRlY3QvTWVtb3J5QmxvY2sudHMiXSwibmFtZXMiOlsiTWVtb3J5VGFwZSIsIk1lbW9yeVRhcGUuY29uc3RydWN0b3IiLCJNZW1vcnlUYXBlLmdldFNpbWlsYXJpdHkiLCJNZW1vcnlUYXBlLnNvZnRNYXhBcnJheSIsIk1lbW9yeVRhcGUuZ2V0U2ltaWxhckFkcmVzc2VzIiwiTWVtb3J5QmxvY2siLCJNZW1vcnlCbG9jay5jb25zdHJ1Y3RvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxPQUFPLFdBQVcsWUFBWSxDQUFDLENBQUM7QUFDdkMsSUFBTyxPQUFPLFdBQVcsWUFBWSxDQUFDLENBQUM7QUFDdkMsSUFBTyxLQUFLLFdBQVcsVUFBVSxDQUFDLENBQUM7QUFLbkMsSUFBYSxVQUFVO0lBYXJCQSxTQWJXQSxVQUFVQSxDQWNuQkEsWUFBb0JBLEVBQ3BCQSxLQUFrQkEsRUFDbEJBLFNBQXNCQSxFQUN0QkEsVUFBdUJBO1FBakIzQkMsaUJBaUtDQTtRQXZKQ0EsNEJBQXVCQSxHQUFXQSxDQUFDQSxDQUFDQTtRQUNwQ0EsMEJBQXFCQSxHQUFXQSxDQUFDQSxDQUFDQTtRQVNoQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsWUFBWUEsQ0FBQ0E7UUFFM0JBLElBQUlBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLEtBQUtBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBO1FBRXBDQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUVwQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFFbkJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLEdBQUdBLENBQUNBLEVBQUVBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLFFBQVFBLEVBQUVBLEVBQUVBLENBQUNBO1lBQzFEQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxD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TUEsRUFBRUEsWUFBWUE7WUFDcEJBLE1BQU1BLEVBQUVBLFdBQVdBO1NBQ3BCQSxDQUFDQSxDQUFDQTtRQUVIQSxBQUNBQSxVQURVQTtRQUNWQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUMzQ0EsQ0FBQ0E7SUFDSEQsa0JBQUNBO0FBQURBLENBeEZBLEFBd0ZDQSxFQXhGZ0MsT0FBTyxDQUFDLE9BQU8sRUF3Ri9DO0FBeEZZLG1CQUFXLEdBQVgsV0F3RlosQ0FBQTtBQUFBLENBQUMiLCJmaWxlIjoic3JjL2FyY2hpdGVjdC9NZW1vcnlCbG9jay5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXR3b3JrID0gcmVxdWlyZSgnLi4vbmV0d29yaycpO1xuaW1wb3J0IHRyYWluZXIgPSByZXF1aXJlKCcuLi90cmFpbmVyJyk7XG5pbXBvcnQgTGF5ZXIgPSByZXF1aXJlKCcuLi9sYXllcicpO1xuaW1wb3J0IG5ldXJvbiA9IHJlcXVpcmUoJy4uL25ldXJvbicpO1xuaW1wb3J0IFN5bmFwdGljID0gcmVxdWlyZSgnLi4vc3luYXB0aWMnKTtcbmltcG9ydCBTcXVhc2ggPSByZXF1aXJlKCcuLi9zcXVhc2gnKTtcblxuZXhwb3J0IGNsYXNzIE1lbW9yeVRhcGUge1xuICBkYXRhOiBGbG9hdDY0QXJyYXlbXTtcblxuICBibG9ja1dpZHRoOiBudW1iZXI7XG4gIGJsb2NrczogbnVtYmVyO1xuXG4gIGxheWVyOiBMYXllci5MYXllcjtcblxuICBwcmV2TGF5ZXJBY3RpdmF0ZTogYW55O1xuXG4gIG1lbW9yeUF0dGVudGlvbkxvY2F0aW9uOiBudW1iZXIgPSAwO1xuICBtZW1vcnlBdHRlbnRpb25XZWlnaHQ6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgbWVtb3J5QmxvY2tzOiBudW1iZXIsXG4gICAgbGF5ZXI6IExheWVyLkxheWVyLFxuICAgIGlucHV0R2F0ZTogTGF5ZXIuTGF5ZXIsXG4gICAgZm9yZ2V0R2F0ZTogTGF5ZXIuTGF5ZXJcbiAgICApIHtcblxuICAgIHRoaXMuYmxvY2tzID0gbWVtb3J5QmxvY2tzO1xuXG4gICAgdGhpcy5kYXRhID0gbmV3IEFycmF5KG1lbW9yeUJsb2Nrcyk7XG5cbiAgICB0aGlzLmJsb2NrV2lkdGggPSBsYXllci5saXN0Lmxlbmd0aDtcblxuICAgIHRoaXMubGF5ZXIgPSBsYXllcjtcblxuICAgIGZvciAodmFyIGxvY2F0aW9uID0gMDsgbG9jYXRpb24gPCB0aGlzLmJsb2NrczsgbG9jYXRpb24rKykge1xuICAgICAgdmFyIGFycmF5ID0gdGhpcy5kYXRhW2xvY2F0aW9uXSA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5ibG9ja1dpZHRoKTtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgYXJyYXlbaV0gPSAwLjEgKiBNYXRoLnJhbmRvbSgpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBcbiAgICAvLyBIYWNrIHRoZSBsYXllciFcbiAgICBcbiAgICB0aGlzLnByZXZMYXllckFjdGl2YXRlID0gdGhpcy5sYXllci5hY3RpdmF0ZS5iaW5kKHRoaXMubGF5ZXIpO1xuXG4gICAgdGhpcy5sYXllci5hY3RpdmF0ZSA9IChpbnB1dD86IFN5bmFwdGljLklOdW1lcmljQXJyYXkpOiBGbG9hdDY0QXJyYXkgPT4ge1xuICAgICAgdmFyIGtleSA9IHRoaXMucHJldkxheWVyQWN0aXZhdGUoaW5wdXQpO1xuXG4gICAgICB2YXIgYWRkR2F0ZSA9IGlucHV0R2F0ZS5jdXJyZW50QWN0aXZhdGlvbjtcbiAgICAgIHZhciBlcmFzZUdhdGUgPSBmb3JnZXRHYXRlLmN1cnJlbnRBY3RpdmF0aW9uO1xuXG4gICAgICB2YXIgc2ltaWxhckFkZHJlc3NlcyA9IHRoaXMuZ2V0U2ltaWxhckFkcmVzc2VzKGtleSk7XG4gICAgICBcbiAgICAgIC8vIGVsZWdpYmxlIG1lbWJsb2NrcyBmb3IgcmVhZC93cml0ZSBvcGVyYXRpb25zXG4gICAgICB2YXIgZWxlZ2libGVJbmRleGVzID0gWzAsIDEsIDJdO1xuICAgICAgdmFyIGVsZWdpYmxlV2VpZ2h0cyA9IFswLjIsIDAuNiwgMC4yXTsgLy8gc2hpZnRpbmcsIHNvZnRtYXhcbiAgICAgIHZhciBmb2N1cyA9IDE7XG4gICAgICBcbiAgICAgIHRoaXMubWVtb3J5QXR0ZW50aW9uV2VpZ2h0ID0gMDtcbiAgICAgIFxuICAgICAgZm9yICh2YXIgYWRkcmVzcyA9IDA7IGFkZHJlc3MgPCBzaW1pbGFyQWRkcmVzc2VzLmxlbmd0aDsgYWRkcmVzcysrKSB7XG4gICAgICAgIHZhciDDnyA9IHNpbWlsYXJBZGRyZXNzZXNbYWRkcmVzc107XG4gICAgICAgIGlmKMOfID4gdGhpcy5tZW1vcnlBdHRlbnRpb25XZWlnaHQpe1xuICAgICAgICAgIHRoaXMubWVtb3J5QXR0ZW50aW9uV2VpZ2h0ID0gw587XG4gICAgICAgICAgdGhpcy5tZW1vcnlBdHRlbnRpb25Mb2NhdGlvbiA9IGFkZHJlc3M7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFxuICAgICAgZWxlZ2libGVJbmRleGVzID0gW3RoaXMubWVtb3J5QXR0ZW50aW9uTG9jYXRpb24gLSAxLCB0aGlzLm1lbW9yeUF0dGVudGlvbkxvY2F0aW9uLCB0aGlzLm1lbW9yeUF0dGVudGlvbkxvY2F0aW9uICsgMV07XG4gICAgICBcbiAgICAgIGZvY3VzID0gdGhpcy5tZW1vcnlBdHRlbnRpb25XZWlnaHQ7XG5cbiAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgZWxlZ2libGVJbmRleGVzLmxlbmd0aDsgbisrKSB7XG4gICAgICAgIFxuICAgICAgICB2YXIgaW5kZXggPSBlbGVnaWJsZUluZGV4ZXNbbl07XG4gICAgICAgIFxuICAgICAgICBpZihpbmRleCA8IDApXG4gICAgICAgICAgaW5kZXggKz0gc2ltaWxhckFkZHJlc3Nlcy5sZW5ndGg7XG4gICAgICAgIGVsc2UgaWYoaW5kZXggPj0gc2ltaWxhckFkZHJlc3Nlcy5sZW5ndGgpXG4gICAgICAgICAgaW5kZXggLT0gc2ltaWxhckFkZHJlc3Nlcy5sZW5ndGg7XG4gICAgICAgICAgXG4gICAgICAgIGVsZWdpYmxlSW5kZXhlc1tuXSA9IGluZGV4O1xuICAgICAgICBcbiAgICAgICAgZWxlZ2libGVXZWlnaHRzW25dID0gTWF0aC5wb3coZWxlZ2libGVXZWlnaHRzW25dLCBmb2N1cyk7XG4gICAgICAgIFxuICAgICAgICB2YXIgTSA9IHRoaXMuZGF0YVtpbmRleF07XG5cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBNLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgLy8gZG8gZXJhc2Ugb3BlcmF0aW9ucyBvbiB0aGUgbWVtb3J5IHRhcGUuIE5UTTogMy4yICgzKVxuICAgICAgICAgIE1baV0gKj0gMSAtIGVyYXNlR2F0ZVtpXSAqIGtleVtpXSAqIGVsZWdpYmxlV2VpZ2h0c1tuXTtcbiAgICAgICAgICAvLyBkbyBhZGQgb3BlcmF0aW9ucyBvbiB0aGUgbWVtb3J5IHRhcGUuIE5UTTogMy4yICg0KVxuICAgICAgICAgIE1baV0gKz0gYWRkR2F0ZVtpXSAqIGtleVtpXSAqIGVsZWdpYmxlV2VpZ2h0c1tuXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBsYXllci5saXN0LmZvckVhY2goKG5ldXJvbiwgaSkgPT4ge1xuICAgICAgICAvLyBtb2RpZnkgdGhlIGN1cnJlbnQga2V5IChyZWFkVmVjdG9yKVxuICAgICAgICB2YXIgdG1wS2V5ID0gMDtcbiAgICAgICAgXG4gICAgICAgIGZvciAodmFyIG4gPSAwOyBuIDwgZWxlZ2libGVJbmRleGVzLmxlbmd0aDsgbisrKSB7XG4gICAgICAgICAgdG1wS2V5ICs9IHRoaXMuZGF0YVtlbGVnaWJsZUluZGV4ZXNbbl1dW2ldICogZWxlZ2libGVXZWlnaHRzW25dO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gd3JpdGUgYWN0aXZhdGlvbiB2YWx1ZSBiYWNrIGludG8gZWFjaCBuZXVyb24sIGFsc28gc3F1YXNoIGl0IG9uIHRoZSBrZXkgdmVjdG9yICAgICAgXG4gICAgICAgIG5ldXJvbi5kZXJpdmF0aXZlID0gbmV1cm9uLnNxdWFzaCh0bXBLZXksIHRydWUpO1xuICAgICAgICBuZXVyb24uYWN0aXZhdGlvbiA9IGtleVtpXSA9IG5ldXJvbi5zcXVhc2godG1wS2V5LCBmYWxzZSk7XG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIGtleTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgZ2V0U2ltaWxhcml0eShhcnJheUE6IFN5bmFwdGljLklOdW1lcmljQXJyYXksIGFycmF5QjogU3luYXB0aWMuSU51bWVyaWNBcnJheSk6IG51bWJlciB7XG4gICAgLy8gaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9Db3NpbmVfc2ltaWxhcml0eVxuICAgIC8vIE5UTTogMy4zLjEgKDYpXG4gICAgdmFyIGRvdFByID0gMDtcblxuICAgIHZhciBhY3VtQSA9IDAsIGFjdW1CID0gMDtcblxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyYXlBLmxlbmd0aDsgaSsrKSB7XG4gICAgICBkb3RQciArPSBhcnJheUFbaV0gKiBhcnJheUJbaV07XG4gICAgICBhY3VtQSArPSBhcnJheUFbaV0gKiBhcnJheUFbaV07XG4gICAgICBhY3VtQiArPSBhcnJheUJbaV0gKiBhcnJheUJbaV07XG4gICAgfVxuXG4gICAgcmV0dXJuIGRvdFByIC8gKE1hdGguc3FydChhY3VtQSkgKiBNYXRoLnNxcnQoYWN1bUIpICsgLjAwMDA1KTtcbiAgfVxuXG4gIHN0YXRpYyBzb2Z0TWF4QXJyYXk8VCBleHRlbmRzIFN5bmFwdGljLklOdW1lcmljQXJyYXk+KGFycmF5OiBULCBzaGFycGVuID0gMSk6IFQge1xuICAgIC8vIGZvciBhbGwgaSDiiIggYXJyYXlcbiAgICAvLyBzdW0gPSDiiJEgYXJyYXlbbl1eZVxuICAgIC8vIGkgPSDDrl5lIC8gc3VtXG4gICAgLy8gd2hlcmUgdGhlIHJlc3VsdCDiiJEgYXJyYXlbMC4ubl0gPSAxXG5cbiAgICBpZiAoIWFycmF5Lmxlbmd0aCkgcmV0dXJuIGFycmF5O1xuXG4gICAgc2hhcnBlbiA9IHNoYXJwZW4gfHwgMTtcblxuICAgIHZhciBzdW0gPSAwO1xuXG4gICAgLy8gc3VtID0g4oiRIGFycmF5W25dXmVcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBhcnJheVtpXSA9IE1hdGguZXhwKHNoYXJwZW4gKiBhcnJheVtpXSk7XG4gICAgICBzdW0gKz0gYXJyYXlbaV07XG4gICAgfVxuXG4gICAgaWYgKHN1bSAhPSAwKSB7XG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgaSsrKSBhcnJheVtpXSAvPSBzdW07XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBkaXYgPSAxIC8gYXJyYXkubGVuZ3RoO1xuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgYXJyYXlbaV0gPSBkaXY7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFycmF5O1xuICB9XG4gIFxuICAvLyBvYnRhaW5zIGFuIGFycmF5IG9mIHNpbWlsYXJpdHkgaW5kZXhlcyBmb3IgZWFjaCBtZW1vcnlCbG9ja1xuICBnZXRTaW1pbGFyQWRyZXNzZXMod2VpZ2h0czogU3luYXB0aWMuSU51bWVyaWNBcnJheSk6IEZsb2F0NjRBcnJheSB7XG4gICAgLy9jaGVja3BvaW50OiAxMHRoIGNpZ2FycmV0XG4gICAgdmFyIGFkZHJlc3NlcyA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5kYXRhLmxlbmd0aCk7XG5cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZGF0YS5sZW5ndGg7IGkrKylcbiAgICAgIGFkZHJlc3Nlc1tpXSA9IE1lbW9yeVRhcGUuZ2V0U2ltaWxhcml0eSh0aGlzLmRhdGFbaV0sIHdlaWdodHMpO1xuXG4gICAgcmV0dXJuIGFkZHJlc3NlcztcbiAgfVxufVxuXG5cbmV4cG9ydCBjbGFzcyBNZW1vcnlCbG9jayBleHRlbmRzIG5ldHdvcmsuTmV0d29yayB7XG4gIHRyYWluZXI6IHRyYWluZXIuVHJhaW5lcjtcbiAgbWVtb3J5VGFwZTogTWVtb3J5VGFwZTtcblxuICBjb25zdHJ1Y3RvcihpbnB1dFNpemU6IG51bWJlciwgbWVtb3J5QmxvY2tzOiBudW1iZXIsIG1lbW9yeVdpZHRoOiBudW1iZXIsIG91dHB1dFNpemU6IG51bWJlcikge1xuXG4gICAgLy8gRE8gTk9UIE9QVElNSVpFIFRISVMgTkVUV09SS1xuICAgIHRoaXMub3B0aW1pemVkID0gZmFsc2U7XG5cbiAgICB2YXIgb3B0aW9uID0ge1xuICAgICAgcGVlcGhvbGVzOiBMYXllci5MYXllci5jb25uZWN0aW9uVHlwZS5BTExfVE9fQUxMLFxuICAgICAgaGlkZGVudG9oaWRkZW46IGZhbHNlLFxuICAgICAgb3V0dG9oaWRkZW46IGZhbHNlLFxuICAgICAgb3V0dG9nYXRlczogZmFsc2UsXG4gICAgICBpbnRvb3V0OiB0cnVlLFxuICAgIH07XG5cbiAgICB2YXIgaW5wdXRMYXllciA9IG5ldyBMYXllci5MYXllcihpbnB1dFNpemUpO1xuICAgIHZhciBoaWRkZW5MYXllcnMgPSBbXTtcbiAgICB2YXIgb3V0cHV0TGF5ZXIgPSBuZXcgTGF5ZXIuTGF5ZXIob3V0cHV0U2l6ZSk7XG5cblxuICAgIC8vI3JlZ2lvbiBnZW5lcmF0ZSBsYXllcnNcblxuICAgIC8vIGdlbmVyYXRlIG1lbW9yeSBibG9ja3MgKG1lbW9yeSBjZWxsIGFuZCByZXNwZWN0aXZlIGdhdGVzKVxuXG4gICAgdmFyIGlucHV0R2F0ZSA9IG5ldyBMYXllci5MYXllcihtZW1vcnlXaWR0aCkuc2V0KHtcbiAgICAgIGJpYXM6IDFcbiAgICB9KTtcblxuICAgIHZhciBmb3JnZXRHYXRlID0gbmV3IExheWVyLkxheWVyKG1lbW9yeVdpZHRoKS5zZXQoe1xuICAgICAgYmlhczogMVxuICAgIH0pO1xuXG4gICAgdmFyIG1lbW9yeUNlbGwgPSBuZXcgTGF5ZXIuTGF5ZXIobWVtb3J5V2lkdGgpO1xuXG5cblxuICAgIHZhciBvdXRwdXRHYXRlID0gbmV3IExheWVyLkxheWVyKG1lbW9yeVdpZHRoKS5zZXQoe1xuICAgICAgYmlhczogMVxuICAgIH0pO1xuXG4gICAgaGlkZGVuTGF5ZXJzLnB1c2goaW5wdXRHYXRlKTtcbiAgICBoaWRkZW5MYXllcnMucHVzaChmb3JnZXRHYXRlKTtcbiAgICBoaWRkZW5MYXllcnMucHVzaChtZW1vcnlDZWxsKTtcbiAgICBoaWRkZW5MYXllcnMucHVzaChvdXRwdXRHYXRlKTtcblxuICAgIC8vIGNvbm5lY3Rpb25zIGZyb20gaW5wdXQgbGF5ZXJcbiAgICB2YXIgaW5wdXQgPSBpbnB1dExheWVyLnByb2plY3QobWVtb3J5Q2VsbCk7XG4gICAgaW5wdXRMYXllci5wcm9qZWN0KGlucHV0R2F0ZSk7XG4gICAgaW5wdXRMYXllci5wcm9qZWN0KGZvcmdldEdhdGUpO1xuICAgIGlucHV0TGF5ZXIucHJvamVjdChvdXRwdXRHYXRlKTtcblxuICAgIC8vIGNvbm5lY3Rpb25zIGZyb20gbWVtb3J5IGNlbGxcbiAgICB2YXIgb3V0cHV0ID0gbWVtb3J5Q2VsbC5wcm9qZWN0KG91dHB1dExheWVyKTtcblxuICAgIC8vIHNlbGYtY29ubmVjdGlvblxuICAgIHZhciBzZWxmID0gbWVtb3J5Q2VsbC5wcm9qZWN0KG1lbW9yeUNlbGwpO1xuICAgICAgXG4gICAgLy8gcGVlcGhvbGVzXG4gICAgbWVtb3J5Q2VsbC5wcm9qZWN0KGlucHV0R2F0ZSwgb3B0aW9uLnBlZXBob2xlcyk7XG4gICAgbWVtb3J5Q2VsbC5wcm9qZWN0KGZvcmdldEdhdGUsIG9wdGlvbi5wZWVwaG9sZXMpO1xuICAgIG1lbW9yeUNlbGwucHJvamVjdChvdXRwdXRHYXRlLCBvcHRpb24ucGVlcGhvbGVzKTtcblxuICAgIC8vIGdhdGVzXG4gICAgaW5wdXRHYXRlLmdhdGUoaW5wdXQsIExheWVyLkxheWVyLmdhdGVUeXBlLklOUFVUKTtcbiAgICBmb3JnZXRHYXRlLmdhdGUoc2VsZiwgTGF5ZXIuTGF5ZXIuZ2F0ZVR5cGUuT05FX1RPX09ORSk7XG4gICAgb3V0cHV0R2F0ZS5nYXRlKG91dHB1dCwgTGF5ZXIuTGF5ZXIuZ2F0ZVR5cGUuT1VUUFVUKTtcblxuXG4gICAgdGhpcy5tZW1vcnlUYXBlID0gbmV3IE1lbW9yeVRhcGUobWVtb3J5QmxvY2tzLCBtZW1vcnlDZWxsLCBpbnB1dEdhdGUsIGZvcmdldEdhdGUpO1xuICAgIFxuICAgIC8vI2VuZHJlZ2lvblxuXG4gICAgLy8gaW5wdXQgdG8gb3V0cHV0IGRpcmVjdCBjb25uZWN0aW9uXG4gICAgaWYgKG9wdGlvbi5pbnRvb3V0KVxuICAgICAgaW5wdXRMYXllci5wcm9qZWN0KG91dHB1dExheWVyKTtcblxuICAgIC8vIHNldCB0aGUgbGF5ZXJzIG9mIHRoZSBuZXVyYWwgbmV0d29ya1xuICAgIHN1cGVyKHtcbiAgICAgIGlucHV0OiBpbnB1dExheWVyLFxuICAgICAgaGlkZGVuOiBoaWRkZW5MYXllcnMsXG4gICAgICBvdXRwdXQ6IG91dHB1dExheWVyXG4gICAgfSk7XG5cbiAgICAvLyB0cmFpbmVyXG4gICAgdGhpcy50cmFpbmVyID0gbmV3IHRyYWluZXIuVHJhaW5lcih0aGlzKTtcbiAgfVxufTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==