<html>
	<head>
		<title>Synapse - Image Filters</title>
		<link rel="icon" type="image/png" href="img/favicon.png">
		<meta charset="UTF-8">
		<meta name="description" content="Training a neural network to learn several image filters - Synapse">
		<meta name="keywords" content="javascript,node.js,neural networks,lstm,long short term memory,library,synapse">
		<meta name="author" content="Juan Cazala">
		<script src='js/jquery.js'></script>
		<script src='js/synapse.js'></script>
		<style>
			body { 
				font-family: 'Open Sans', sans-serif;
				position: relative;
				line-height: 120%;
				margin: 0px;
			}
			.container {
				width: 1024px;
				margin: 0 auto;
			}
			.title {
				text-align: center;
				color: rgb(125, 125, 125);
				font-size: 34px;
				padding-top: 50px;
				height: 50px;
				cursor: pointer;
			}
			.title b{
				color:rgb(50, 50, 50);;
			}
			.title:hover{
				opacity: .8;
			}
			.subtitle: {
				font-weight: bold;
			}

			p {
				padding: 10px;
				font-size: 13px;
			}
			
			a{
				color: black;
				font-weight: bold;
			}

			img, canvas {
				border: 1px solid lightgray;
				box-shadow: 0 0 10px lightgray;
				padding: 2px;
				margin-right: 10px;
				margin-bottom: 10px;
				display: block;
			}

			.image_frame {
				display: inline-block;
				text-align: center;
				font-size: 12px;
			}

			.train {
				display: none;
			}
		</style>
		<script>

			var perceptron = null;
			var worker = null;
			var index = 0;
			var color_data = null;
			var grayscale_data = null;
			var original_data = null;
			var canvas = null;
			var context = null;
			var size = 125 * 125;
			var trial = 0;

			$(function(){
				canvas = canvas || document.getElementById('canvas');
		        context = context || canvas.getContext('2d');
			})

			var getData = function(imageObj){

				canvas = canvas || document.getElementById('canvas');
		        context = context || canvas.getContext('2d');

		        context.drawImage(imageObj, 0, 0);

		        var imageData = context.getImageData(0, 0, 125, 125);
		        return imageData.data;
			}

			var train = function(){
				trial = 0;

				perceptron = new Architect.Perceptron(27,8,3);
		        color_data = getData(document.getElementById('input'));
		        grayscale_data = getData(document.getElementById('output'));
 				original_data = getData(document.getElementById('original'));

 				$(".train").show();
				iteration();
			}

			
			var iteration = function(){
				trial++;

				for (index = 0; index < size; index+=2)
				{
					px = pixel(color_data, 0, 0);
					px = px.concat(pixel(color_data, -1, -1));
					px = px.concat(pixel(color_data, 0, -1));
					px = px.concat(pixel(color_data, 1, -1));
					px = px.concat(pixel(color_data, -1, 0));
					px = px.concat(pixel(color_data, 1, 0));
					px = px.concat(pixel(color_data, -1, 1));
					px = px.concat(pixel(color_data, 0, 1));
					px = px.concat(pixel(color_data, 1, 1));
					perceptron.activate(px);
					perceptron.propagate(.3, pixel(grayscale_data,0,0));
				}
				preview();
			}

			var pixel = function(data, ox, oy){
				var y = index / 125 | 0;
				var x = index % 125;

				if (ox && (x + ox) > 0 && (x + ox) < 125)
					x += ox;
				if (oy && (y + oy) > 0 && (y + oy) < 125)
					y += oy;

				var red = data[((125 * y) + x) * 4];
		        var green = data[((125 * y) + x) * 4 + 1];
		        var blue = data[((125 * y) + x) * 4 + 2];

		        return [red / 255, green / 255, blue / 255];
			}

			var preview = function(){
				var imageData = context.getImageData(0, 0, 125, 125);
				for (index = 0; index < size; index++)
				{
					var px = pixel(original_data, 0, 0);
					px = px.concat(pixel(original_data, -1, -1));
					px = px.concat(pixel(original_data, 0, -1));
					px = px.concat(pixel(original_data, 1, -1));
					px = px.concat(pixel(original_data, -1, 0));
					px = px.concat(pixel(original_data, 1, 0));
					px = px.concat(pixel(original_data, -1, 1));
					px = px.concat(pixel(original_data, 0, 1));
					px = px.concat(pixel(original_data, 1, 1));
					var rgb = perceptron.activate(px);
					imageData.data[index * 4] = (rgb[0] )* 255;
					imageData.data[index * 4 + 1] = (rgb[1] ) * 255;
					imageData.data[index * 4 + 2] = (rgb[2] ) * 255;
				}
				context.putImageData(imageData,0,0);
				setTimeout(iteration,100);
			}

		</script>
		<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54879338-2', 'auto');
  ga('send', 'pageview');

</script>
	</head>
	<body>
		
		<div class="container"><div class='title' onclick="window.location='index.html';"><b>Synapse</b></div><div style="font-weight: bold;">Image Filters</div>
		<p> In this demo, a perceptron will be trained to learn how to apply different filters to an image. During the training, the network will receive a picture as an input, and a filtered version of that same picture as an output (RGB values of their pixels). Eventually, the network will be able to take any picture as input and it will output a filtered version of it.</p>
		<p><b>Training set:</b></p>
		<div class="image_frame"><img src='img/cat.png' id='input'/><span>input</span></div>
		<div class="image_frame"><img src='img/cat_bw.png' id='output'/><span>output</span></div>

		<p>&nbsp;</p>
		<p> Start training: 
			<select id="comboA" onchange="document.getElementById('output').src = this.value">
				<option value="img/cat_bw.png">Grayscale</option>
				<option value="img/cat_blur.png">Blur</option>
				<option value="img/cat_glow.png">Glowing Edges</option>
				<option value="img/cat_texture.png">Texture</option>
				<option value="img/cat_neon.png">Neon Glow</option>
			</select>
			<button onclick="train();">START</button></p>
		
		<div class="train">
		<div class="image_frame"><img src='img/cat_original.png' id='original'/><span>original</span></div>
		<div class="image_frame"><canvas id='canvas' width =125 height=125></canvas><span>filtered</span></div>
		</div>
		</div>
	</body>
</html>