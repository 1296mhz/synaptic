var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var network = require('../network');
var trainer = require('../trainer');
var Layer = require('../layer');
var Squash = require('../squash');
var _utils = require('../utils');
var Utils = _utils.Utils;
var NTM = (function (_super) {
    __extends(NTM, _super);
    function NTM(inputs, outputs, memBlocks, blockWidth, heads, hiddenSize) {
        // build the memory
        _super.call(this);
        this.heads = new Array();
        this.dirty = false;
        this.trainer = new trainer.Trainer(this);
        this.blocks = memBlocks;
        this.blockWidth = blockWidth;
        this.data = new Array(this.blocks);
        for (var index = 0; index < this.data.length; index++) {
            this.data[index] = new Float64Array(blockWidth);
        }
        this.clean();
        // build the network
        var inputLength = inputs + heads * memBlocks;
        this.inputValues = new Float64Array(inputLength);
        this.layers.input = this.inputLayer = new Layer.Layer(inputLength);
        this.hiddenLayer = new Layer.Layer(hiddenSize);
        this.layers.output = this.outputLayer = new Layer.Layer(outputs);
        this.inputLayer.project(this.hiddenLayer, Layer.Layer.connectionType.ALL_TO_ALL);
        this.hiddenLayer.project(this.outputLayer, Layer.Layer.connectionType.ALL_TO_ALL);
        var inputCounter = inputs - 1;
        for (var headIndex = 0; headIndex < heads; headIndex++) {
            this.addHead(this.inputValues.subarray(inputCounter, inputCounter + memBlocks));
            inputCounter += memBlocks;
        }
        this.optimized = false;
    }
    NTM.prototype.clean = function () {
        for (var location = 0; location < this.blocks; location++) {
            Utils.initRandomSoftmaxArray(this.data[location]);
        }
        this.dirty = false;
    };
    NTM.prototype.activate = function (input) {
        this.inputValues.set(input);
        this.inputLayer.activate(this.inputValues);
        this.hiddenLayer.activate();
        this.doTimeStep();
        return this.outputLayer.activate();
    };
    NTM.prototype.propagate = function (rate, target) {
        this.outputLayer.propagate(rate, target);
        for (var i = this.heads.length - 1; i >= 0; i--) {
            this.heads[i].layer.propagate(rate);
        }
        this.hiddenLayer.propagate(rate);
        this.dirty = true;
    };
    NTM.prototype.addHead = function (subArray) {
        var head = new Head(this, subArray);
        this.heads.push(head);
        return head;
    };
    NTM.prototype.doTimeStep = function () {
        var _this = this;
        this.heads.forEach(function (head, headIndex) {
            head.doTimeStep();
        });
        // parallelizable
        this.heads.forEach(function (head, headIndex) {
            _this.doErase(head.w_weightings, head.eraseGate);
        });
        // parallelizable
        this.heads.forEach(function (head, headIndex) {
            _this.doAdd(head.w_weightings, head.addGate);
        });
        //this.data.forEach((e) => e = Utils.softMax(e))
    };
    NTM.prototype.doAdd = function (w, addGate) {
        for (var n = 0; n < this.blocks; n++) {
            var M = this.data[n];
            for (var i = 0; i < this.blockWidth; i++) {
                M[i] += addGate[n] * w[i];
            }
        }
    };
    NTM.prototype.doErase = function (w, eraseGate) {
        for (var n = 0; n < this.blocks; n++) {
            var M = this.data[n];
            for (var i = 0; i < this.blockWidth; i++) {
                M[i] *= 1 - eraseGate[n] * w[i];
            }
        }
    };
    return NTM;
})(network.Network);
exports.NTM = NTM;
var Head = (function () {
    function Head(memory, destinationArray) {
        this.s_shiftingValue = null;
        this.prevFocus = 1;
        this.memory = memory;
        this.wc_focusedWeights = new Float64Array(this.memory.blocks);
        this.w_weightings = new Float64Array(this.memory.blocks);
        Utils.initRandomSoftmaxArray(this.w_weightings);
        this.shiftLength = 3; //this.memory.blocks;
        this.s_shiftingVector = new Float64Array(this.shiftLength);
        this.k_keys = new Float64Array(this.memory.blockWidth);
        this.ß_keyStrength = 0;
        this.eraseGate = new Float64Array(this.memory.blocks);
        this.addGate = new Float64Array(this.memory.blocks);
        this.readVector = destinationArray || new Float64Array(this.memory.blocks);
        this.layer = new Layer.Layer(this.memory.blockWidth + this.memory.blocks * 3 + Head.ADDITIONAL_INPUT_VALUES + this.shiftLength);
        this.memory.hiddenLayer.project(this.layer, Layer.Layer.connectionType.ALL_TO_ALL);
        this.layer.project(this.memory.outputLayer, Layer.Layer.connectionType.ALL_TO_ALL);
        this.circulantMatrix = Utils.buildCirculantMatrix(this.memory.blocks);
    }
    Head.prototype.readParams = function (activation) {
        this.ß_keyStrength = Squash.SOFTPLUS(activation[0]);
        this.g_interpolation = Squash.LOGISTIC(activation[1]);
        this.Y_focus = Math.log(Math.exp(activation[2] + 1)) + 1; //Squash.SOFTPLUS(activation[2]) + 1;
        var startAt = 3;
        for (var k = 0; k < this.k_keys.length; k++) {
            this.k_keys[k] = this.layer.list[k + startAt].activation;
        }
        startAt += this.k_keys.length;
        for (var k = 0; k < this.addGate.length; k++) {
            this.addGate[k] = this.layer.list[k + startAt].derivative;
        }
        startAt += this.addGate.length;
        for (var k = 0; k < this.eraseGate.length; k++) {
            this.eraseGate[k] = Squash.LOGISTIC(this.layer.list[k + startAt].activation);
        }
        startAt += this.eraseGate.length;
        for (var k = 0; k < this.shiftLength; k++) {
            this.s_shiftingVector[k] = this.layer.list[k + startAt].activation;
        }
        var M = this.memory.data;
        for (var i = 0; i < M.length; i++)
            this.wc_focusedWeights[i] = Utils.getCosineSimilarity(M[i], this.k_keys);
        // focus by location (interpolation)
        Utils.interpolateArray(this.wc_focusedWeights, this.w_weightings, this.g_interpolation);
        // convolutional shift
        this.doShiftings();
        // sharpening
        Utils.sharpArray(this.w_weightings, this.wc_focusedWeights, this.Y_focus);
        // since ∑ w = 1, we have to softmax the array
        Utils.softMax(this.w_weightings);
        /// we got wt!
    };
    Head.prototype.doShiftings = function () {
        Utils.softMax(this.s_shiftingVector);
        Utils.vectorInvertedShifting(this.wc_focusedWeights, this.s_shiftingVector);
    };
    Head.prototype.doTimeStep = function () {
        var activation = this.layer.activate();
        this.readParams(activation);
        for (var index = 0; index < this.memory.blocks; index++) {
            this.readVector[index] = 0;
            for (var cell = 0; cell < this.memory.blockWidth; cell++) {
                this.readVector[index] += this.memory.data[index][cell] * this.w_weightings[index];
            }
        }
    };
    Head.ADDITIONAL_INPUT_VALUES = 3;
    return Head;
})();
exports.Head = Head;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9hcmNoaXRlY3QvTlRNLnRzIl0sIm5hbWVzIjpbIk5UTSIsIk5UTS5jb25zdHJ1Y3RvciIsIk5UTS5jbGVhbiIsIk5UTS5hY3RpdmF0ZSIsIk5UTS5wcm9wYWdhdGUiLCJOVE0uYWRkSGVhZCIsIk5UTS5kb1RpbWVTdGVwIiwiTlRNLmRvQWRkIiwiTlRNLmRvRXJhc2UiLCJIZWFkIiwiSGVhZC5jb25zdHJ1Y3RvciIsIkhlYWQucmVhZFBhcmFtcyIsIkhlYWQuZG9TaGlmdGluZ3MiLCJIZWFkLmRvVGltZVN0ZXAiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQU8sT0FBTyxXQUFXLFlBQVksQ0FBQyxDQUFDO0FBQ3ZDLElBQU8sT0FBTyxXQUFXLFlBQVksQ0FBQyxDQUFDO0FBQ3ZDLElBQU8sS0FBSyxXQUFXLFVBQVUsQ0FBQyxDQUFDO0FBR25DLElBQU8sTUFBTSxXQUFXLFdBQVcsQ0FBQyxDQUFDO0FBQ3JDLElBQU8sTUFBTSxXQUFXLFVBQVUsQ0FBQyxDQUFDO0FBRXBDLElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7QUFFekIsSUFBYSxHQUFHO0lBQVNBLFVBQVpBLEdBQUdBLFVBQXdCQTtJQWtCdENBLFNBbEJXQSxHQUFHQSxDQWtCRkEsTUFBY0EsRUFBRUEsT0FBZUEsRUFBRUEsU0FBaUJBLEVBQUVBLFVBQWtCQSxFQUFFQSxLQUFhQSxFQUFFQSxVQUFrQkE7UUFDbkhDLG1CQUFtQkE7UUFFbkJBLGlCQUFPQSxDQUFDQTtRQWJWQSxVQUFLQSxHQUFXQSxJQUFJQSxLQUFLQSxFQUFFQSxDQUFDQTtRQVE1QkEsVUFBS0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFPWkEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsSUFBSUEsT0FBT0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFFekNBLElBQUlBLENBQUNBLE1BQU1BLEdBQUdBLFNBQVNBLENBQUNBO1FBQ3hCQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxVQUFVQSxDQUFDQTtRQUU3QkEsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDbkNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLEdBQUdBLENBQUNBLEVBQUVBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLEtBQUtBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3REQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxJQUFJQSxZQUFZQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUVsREEsQ0FBQ0E7UUFFREEsSUFBSUEsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7UUFFYkEsQUFFQUEsb0JBRm9CQTtZQUVoQkEsV0FBV0EsR0FBR0EsTUFBTUEsR0FBR0EsS0FBS0EsR0FBR0EsU0FBU0EsQ0FBQ0E7UUFFN0NBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO1FBRWpEQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQTtRQUNuRUEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsSUFBSUEsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7UUFDL0NBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBSWpFQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxFQUFFQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxjQUFjQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUNqRkEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsRUFBRUEsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7UUFFbEZBLElBQUlBLFlBQVlBLEdBQUdBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBO1FBRTlCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxTQUFTQSxHQUFHQSxDQUFDQSxFQUFFQSxTQUFTQSxHQUFHQSxLQUFLQSxFQUFFQSxTQUFTQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUN2REEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsWUFBWUEsRUFBRUEsWUFBWUEsR0FBR0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaEZBLFlBQVlBLElBQUlBLFNBQVNBLENBQUNBO1FBQzVCQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxLQUFLQSxDQUFDQTtJQUN6QkEsQ0FBQ0E7SUFFREQsbUJBQUtBLEdBQUxBO1FBQ0VFLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLEdBQUdBLENBQUNBLEVBQUVBLFFBQVFBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLFFBQVFBLEVBQUVBLEVBQUVBLENBQUNBO1lBQzFEQSxLQUFLQSxDQUFDQSxzQkFBc0JBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO1FBQ3BEQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUFFREYsc0JBQVFBLEdBQVJBLFVBQVNBLEtBQTZCQTtRQUNwQ0csSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsR0FBR0EsQ0FBTUEsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFFakNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO1FBQzNDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQTtRQUU1QkEsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0E7UUFFbEJBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBO0lBQ3JDQSxDQUFDQTtJQUVESCx1QkFBU0EsR0FBVEEsVUFBVUEsSUFBWUEsRUFBRUEsTUFBOEJBO1FBQ3BESSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUN6Q0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDaERBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ3RDQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNqQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0E7SUFDcEJBLENBQUNBO0lBRURKLHFCQUFPQSxHQUFQQSxVQUFRQSxRQUFzQkE7UUFDNUJLLElBQUlBLElBQUlBLEdBQUdBLElBQUlBLElBQUlBLENBQUNBLElBQUlBLEVBQUVBLFFBQVFBLENBQUNBLENBQUNBO1FBQ3BDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUN0QkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7SUFDZEEsQ0FBQ0E7SUFFREwsd0JBQVVBLEdBQVZBO1FBQUFNLGlCQWdCQ0E7UUFmQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBQ0EsSUFBSUEsRUFBRUEsU0FBU0E7WUFDakNBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO1FBQ3BCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVIQSxBQUNBQSxpQkFEaUJBO1FBQ2pCQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFDQSxJQUFJQSxFQUFFQSxTQUFTQTtZQUNqQ0EsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsWUFBWUEsRUFBRUEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0E7UUFDbERBLENBQUNBLENBQUNBLENBQUNBO1FBRUhBLEFBQ0FBLGlCQURpQkE7UUFDakJBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLFVBQUNBLElBQUlBLEVBQUVBLFNBQVNBO1lBQ2pDQSxLQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxZQUFZQSxFQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtRQUM5Q0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFSEEsZ0RBQWdEQTtJQUNsREEsQ0FBQ0E7SUFFRE4sbUJBQUtBLEdBQUxBLFVBQU1BLENBQXlCQSxFQUFFQSxPQUErQkE7UUFDOURPLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3JDQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNyQkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7Z0JBQ3pDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM1QkEsQ0FBQ0E7UUFDSEEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFFRFAscUJBQU9BLEdBQVBBLFVBQVFBLENBQXlCQSxFQUFFQSxTQUFpQ0E7UUFDbEVRLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3JDQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNyQkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7Z0JBQ3pDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsQ0EsQ0FBQ0E7UUFDSEEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFDSFIsVUFBQ0E7QUFBREEsQ0FqSUEsQUFpSUNBLEVBakl3QixPQUFPLENBQUMsT0FBTyxFQWlJdkM7QUFqSVksV0FBRyxHQUFILEdBaUlaLENBQUE7QUFJRCxJQUFhLElBQUk7SUF3QmZTLFNBeEJXQSxJQUFJQSxDQXdCSEEsTUFBV0EsRUFBRUEsZ0JBQStCQTtRQWJ4REMsb0JBQWVBLEdBQVdBLElBQUlBLENBQUNBO1FBSy9CQSxjQUFTQSxHQUFXQSxDQUFDQSxDQUFDQTtRQVNwQkEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0E7UUFDckJBLElBQUlBLENBQUNBLGlCQUFpQkEsR0FBR0EsSUFBSUEsWUFBWUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDOURBLElBQUlBLENBQUNBLFlBQVlBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1FBRXpEQSxLQUFLQSxDQUFDQSxzQkFBc0JBLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBO1FBRWhEQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxDQUFDQSxFQUFFQSxxQkFBcUJBO1FBRTNDQSxJQUFJQSxDQUFDQSxnQkFBZ0JBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO1FBQzNEQSxJQUFJQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUN2REEsSUFBSUEsQ0FBQ0EsYUFBYUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDdkJBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1FBQ3REQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxJQUFJQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUNwREEsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsZ0JBQWdCQSxJQUFJQSxJQUFJQSxZQUFZQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUUzRUEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsVUFBVUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsdUJBQXVCQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQTtRQUVoSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsRUFBRUEsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsY0FBY0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7UUFDbkZBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLEVBQUVBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLGNBQWNBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBO1FBRW5GQSxJQUFJQSxDQUFDQSxlQUFlQSxHQUFHQSxLQUFLQSxDQUFDQSxvQkFBb0JBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO0lBQ3hFQSxDQUFDQTtJQUVPRCx5QkFBVUEsR0FBbEJBLFVBQW1CQSxVQUFrQ0E7UUFFbkRFLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQ3BEQSxJQUFJQSxDQUFDQSxlQUFlQSxHQUFHQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN0REEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBQ0EscUNBQXFDQTtRQUU5RkEsSUFBSUEsT0FBT0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDaEJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQzVDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxHQUFHQSxPQUFPQSxDQUFDQSxDQUFDQSxVQUFVQSxDQUFDQTtRQUMzREEsQ0FBQ0E7UUFFREEsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFDOUJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQzdDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxHQUFHQSxPQUFPQSxDQUFDQSxDQUFDQSxVQUFVQSxDQUFDQTtRQUM1REEsQ0FBQ0E7UUFFREEsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFDL0JBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQy9DQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxJ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QSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtZQUNyRkEsQ0FBQ0E7UUFDSEEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFoSE1KLDRCQUF1QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFpSHJDQSxXQUFDQTtBQUFEQSxDQWxIQSxBQWtIQ0EsSUFBQTtBQWxIWSxZQUFJLEdBQUosSUFrSFosQ0FBQSIsImZpbGUiOiJzcmMvYXJjaGl0ZWN0L05UTS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBuZXR3b3JrID0gcmVxdWlyZSgnLi4vbmV0d29yaycpO1xuaW1wb3J0IHRyYWluZXIgPSByZXF1aXJlKCcuLi90cmFpbmVyJyk7XG5pbXBvcnQgTGF5ZXIgPSByZXF1aXJlKCcuLi9sYXllcicpO1xuaW1wb3J0IG5ldXJvbiA9IHJlcXVpcmUoJy4uL25ldXJvbicpO1xuaW1wb3J0IFN5bmFwdGljID0gcmVxdWlyZSgnLi4vc3luYXB0aWMnKTtcbmltcG9ydCBTcXVhc2ggPSByZXF1aXJlKCcuLi9zcXVhc2gnKTtcbmltcG9ydCBfdXRpbHMgPSByZXF1aXJlKCcuLi91dGlscycpO1xuXG52YXIgVXRpbHMgPSBfdXRpbHMuVXRpbHM7XG5cbmV4cG9ydCBjbGFzcyBOVE0gZXh0ZW5kcyBuZXR3b3JrLk5ldHdvcmsge1xuICB0cmFpbmVyOiB0cmFpbmVyLlRyYWluZXI7XG5cbiAgZGF0YTogRmxvYXQ2NEFycmF5W107XG5cbiAgYmxvY2tXaWR0aDogbnVtYmVyO1xuICBibG9ja3M6IG51bWJlcjtcblxuICBoZWFkczogSGVhZFtdID0gbmV3IEFycmF5KCk7XG5cbiAgaW5wdXRWYWx1ZXM6IEZsb2F0NjRBcnJheTtcblxuICBpbnB1dExheWVyOiBMYXllci5MYXllcjtcbiAgaGlkZGVuTGF5ZXI6IExheWVyLkxheWVyO1xuICBvdXRwdXRMYXllcjogTGF5ZXIuTGF5ZXI7XG5cbiAgZGlydHkgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihpbnB1dHM6IG51bWJlciwgb3V0cHV0czogbnVtYmVyLCBtZW1CbG9ja3M6IG51bWJlciwgYmxvY2tXaWR0aDogbnVtYmVyLCBoZWFkczogbnVtYmVyLCBoaWRkZW5TaXplOiBudW1iZXIpIHtcbiAgICAvLyBidWlsZCB0aGUgbWVtb3J5XG4gICAgXG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMudHJhaW5lciA9IG5ldyB0cmFpbmVyLlRyYWluZXIodGhpcyk7XG5cbiAgICB0aGlzLmJsb2NrcyA9IG1lbUJsb2NrcztcbiAgICB0aGlzLmJsb2NrV2lkdGggPSBibG9ja1dpZHRoO1xuXG4gICAgdGhpcy5kYXRhID0gbmV3IEFycmF5KHRoaXMuYmxvY2tzKTtcbiAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5kYXRhLmxlbmd0aDsgaW5kZXgrKykge1xuICAgICAgdGhpcy5kYXRhW2luZGV4XSA9IG5ldyBGbG9hdDY0QXJyYXkoYmxvY2tXaWR0aCk7XG5cbiAgICB9XG5cbiAgICB0aGlzLmNsZWFuKCk7XG4gICAgXG4gICAgLy8gYnVpbGQgdGhlIG5ldHdvcmtcbiAgICBcbiAgICB2YXIgaW5wdXRMZW5ndGggPSBpbnB1dHMgKyBoZWFkcyAqIG1lbUJsb2NrcztcblxuICAgIHRoaXMuaW5wdXRWYWx1ZXMgPSBuZXcgRmxvYXQ2NEFycmF5KGlucHV0TGVuZ3RoKTtcblxuICAgIHRoaXMubGF5ZXJzLmlucHV0ID0gdGhpcy5pbnB1dExheWVyID0gbmV3IExheWVyLkxheWVyKGlucHV0TGVuZ3RoKTtcbiAgICB0aGlzLmhpZGRlbkxheWVyID0gbmV3IExheWVyLkxheWVyKGhpZGRlblNpemUpO1xuICAgIHRoaXMubGF5ZXJzLm91dHB1dCA9IHRoaXMub3V0cHV0TGF5ZXIgPSBuZXcgTGF5ZXIuTGF5ZXIob3V0cHV0cyk7XG5cblxuXG4gICAgdGhpcy5pbnB1dExheWVyLnByb2plY3QodGhpcy5oaWRkZW5MYXllciwgTGF5ZXIuTGF5ZXIuY29ubmVjdGlvblR5cGUuQUxMX1RPX0FMTCk7XG4gICAgdGhpcy5oaWRkZW5MYXllci5wcm9qZWN0KHRoaXMub3V0cHV0TGF5ZXIsIExheWVyLkxheWVyLmNvbm5lY3Rpb25UeXBlLkFMTF9UT19BTEwpO1xuXG4gICAgdmFyIGlucHV0Q291bnRlciA9IGlucHV0cyAtIDE7XG5cbiAgICBmb3IgKHZhciBoZWFkSW5kZXggPSAwOyBoZWFkSW5kZXggPCBoZWFkczsgaGVhZEluZGV4KyspIHtcbiAgICAgIHRoaXMuYWRkSGVhZCh0aGlzLmlucHV0VmFsdWVzLnN1YmFycmF5KGlucHV0Q291bnRlciwgaW5wdXRDb3VudGVyICsgbWVtQmxvY2tzKSk7XG4gICAgICBpbnB1dENvdW50ZXIgKz0gbWVtQmxvY2tzO1xuICAgIH1cblxuICAgIHRoaXMub3B0aW1pemVkID0gZmFsc2U7XG4gIH1cblxuICBjbGVhbigpIHtcbiAgICBmb3IgKHZhciBsb2NhdGlvbiA9IDA7IGxvY2F0aW9uIDwgdGhpcy5ibG9ja3M7IGxvY2F0aW9uKyspIHtcbiAgICAgIFV0aWxzLmluaXRSYW5kb21Tb2Z0bWF4QXJyYXkodGhpcy5kYXRhW2xvY2F0aW9uXSk7XG4gICAgfVxuICAgIHRoaXMuZGlydHkgPSBmYWxzZTtcbiAgfVxuXG4gIGFjdGl2YXRlKGlucHV0OiBTeW5hcHRpYy5JTnVtZXJpY0FycmF5KSB7XG4gICAgdGhpcy5pbnB1dFZhbHVlcy5zZXQoPGFueT5pbnB1dCk7XG5cbiAgICB0aGlzLmlucHV0TGF5ZXIuYWN0aXZhdGUodGhpcy5pbnB1dFZhbHVlcyk7XG4gICAgdGhpcy5oaWRkZW5MYXllci5hY3RpdmF0ZSgpO1xuXG4gICAgdGhpcy5kb1RpbWVTdGVwKCk7XG5cbiAgICByZXR1cm4gdGhpcy5vdXRwdXRMYXllci5hY3RpdmF0ZSgpO1xuICB9XG5cbiAgcHJvcGFnYXRlKHJhdGU6IG51bWJlciwgdGFyZ2V0OiBTeW5hcHRpYy5JTnVtZXJpY0FycmF5KSB7XG4gICAgdGhpcy5vdXRwdXRMYXllci5wcm9wYWdhdGUocmF0ZSwgdGFyZ2V0KTtcbiAgICBmb3IgKHZhciBpID0gdGhpcy5oZWFkcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgdGhpcy5oZWFkc1tpXS5sYXllci5wcm9wYWdhdGUocmF0ZSk7XG4gICAgfVxuICAgIHRoaXMuaGlkZGVuTGF5ZXIucHJvcGFnYXRlKHJhdGUpO1xuICAgIHRoaXMuZGlydHkgPSB0cnVlO1xuICB9XG5cbiAgYWRkSGVhZChzdWJBcnJheTogRmxvYXQ2NEFycmF5KTogSGVhZCB7XG4gICAgdmFyIGhlYWQgPSBuZXcgSGVhZCh0aGlzLCBzdWJBcnJheSk7XG4gICAgdGhpcy5oZWFkcy5wdXNoKGhlYWQpO1xuICAgIHJldHVybiBoZWFkO1xuICB9XG5cbiAgZG9UaW1lU3RlcCgpIHtcbiAgICB0aGlzLmhlYWRzLmZvckVhY2goKGhlYWQsIGhlYWRJbmRleCkgPT4ge1xuICAgICAgaGVhZC5kb1RpbWVTdGVwKCk7XG4gICAgfSk7XG4gICAgXG4gICAgLy8gcGFyYWxsZWxpemFibGVcbiAgICB0aGlzLmhlYWRzLmZvckVhY2goKGhlYWQsIGhlYWRJbmRleCkgPT4ge1xuICAgICAgdGhpcy5kb0VyYXNlKGhlYWQud193ZWlnaHRpbmdzLCBoZWFkLmVyYXNlR2F0ZSk7XG4gICAgfSk7XG4gICAgXG4gICAgLy8gcGFyYWxsZWxpemFibGVcbiAgICB0aGlzLmhlYWRzLmZvckVhY2goKGhlYWQsIGhlYWRJbmRleCkgPT4ge1xuICAgICAgdGhpcy5kb0FkZChoZWFkLndfd2VpZ2h0aW5ncywgaGVhZC5hZGRHYXRlKTtcbiAgICB9KTtcbiAgICBcbiAgICAvL3RoaXMuZGF0YS5mb3JFYWNoKChlKSA9PiBlID0gVXRpbHMuc29mdE1heChlKSlcbiAgfVxuXG4gIGRvQWRkKHc6IFN5bmFwdGljLklOdW1lcmljQXJyYXksIGFkZEdhdGU6IFN5bmFwdGljLklOdW1lcmljQXJyYXkpIHtcbiAgICBmb3IgKHZhciBuID0gMDsgbiA8IHRoaXMuYmxvY2tzOyBuKyspIHtcbiAgICAgIHZhciBNID0gdGhpcy5kYXRhW25dO1xuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJsb2NrV2lkdGg7IGkrKykge1xuICAgICAgICBNW2ldICs9IGFkZEdhdGVbbl0gKiB3W2ldO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGRvRXJhc2UodzogU3luYXB0aWMuSU51bWVyaWNBcnJheSwgZXJhc2VHYXRlOiBTeW5hcHRpYy5JTnVtZXJpY0FycmF5KSB7XG4gICAgZm9yICh2YXIgbiA9IDA7IG4gPCB0aGlzLmJsb2NrczsgbisrKSB7XG4gICAgICB2YXIgTSA9IHRoaXMuZGF0YVtuXTtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5ibG9ja1dpZHRoOyBpKyspIHtcbiAgICAgICAgTVtpXSAqPSAxIC0gZXJhc2VHYXRlW25dICogd1tpXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuXG5cbmV4cG9ydCBjbGFzcyBIZWFkIHtcbiAgc3RhdGljIEFERElUSU9OQUxfSU5QVVRfVkFMVUVTID0gMztcblxuICBtZW1vcnk6IE5UTTtcblxuICB3X3dlaWdodGluZ3M6IEZsb2F0NjRBcnJheTtcbiAgZXJhc2VHYXRlOiBGbG9hdDY0QXJyYXk7XG4gIGFkZEdhdGU6IEZsb2F0NjRBcnJheTtcbiAga19rZXlzOiBGbG9hdDY0QXJyYXk7XG4gIGdfaW50ZXJwb2xhdGlvbjogbnVtYmVyO1xuICBZX2ZvY3VzOiBudW1iZXI7XG4gIHNfc2hpZnRpbmdWYWx1ZTogbnVtYmVyID0gbnVsbDtcbiAgc19zaGlmdGluZ1ZlY3RvcjogRmxvYXQ2NEFycmF5O1xuICB3Y19mb2N1c2VkV2VpZ2h0czogRmxvYXQ2NEFycmF5O1xuICByZWFkVmVjdG9yOiBGbG9hdDY0QXJyYXk7XG4gIMOfX2tleVN0cmVuZ3RoOiBudW1iZXI7XG4gIHByZXZGb2N1czogbnVtYmVyID0gMTtcblxuICBzaGlmdExlbmd0aDogbnVtYmVyO1xuXG4gIGxheWVyOiBMYXllci5MYXllcjtcblxuICBjaXJjdWxhbnRNYXRyaXg6IEZsb2F0NjRBcnJheVtdO1xuXG4gIGNvbnN0cnVjdG9yKG1lbW9yeTogTlRNLCBkZXN0aW5hdGlvbkFycmF5PzogRmxvYXQ2NEFycmF5KSB7XG4gICAgdGhpcy5tZW1vcnkgPSBtZW1vcnk7XG4gICAgdGhpcy53Y19mb2N1c2VkV2VpZ2h0cyA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5tZW1vcnkuYmxvY2tzKTtcbiAgICB0aGlzLndfd2VpZ2h0aW5ncyA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5tZW1vcnkuYmxvY2tzKTtcblxuICAgIFV0aWxzLmluaXRSYW5kb21Tb2Z0bWF4QXJyYXkodGhpcy53X3dlaWdodGluZ3MpO1xuXG4gICAgdGhpcy5zaGlmdExlbmd0aCA9IDM7IC8vdGhpcy5tZW1vcnkuYmxvY2tzO1xuXG4gICAgdGhpcy5zX3NoaWZ0aW5nVmVjdG9yID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLnNoaWZ0TGVuZ3RoKTtcbiAgICB0aGlzLmtfa2V5cyA9IG5ldyBGbG9hdDY0QXJyYXkodGhpcy5tZW1vcnkuYmxvY2tXaWR0aCk7XG4gICAgdGhpcy7Dn19rZXlTdHJlbmd0aCA9IDA7XG4gICAgdGhpcy5lcmFzZUdhdGUgPSBuZXcgRmxvYXQ2NEFycmF5KHRoaXMubWVtb3J5LmJsb2Nrcyk7XG4gICAgdGhpcy5hZGRHYXRlID0gbmV3IEZsb2F0NjRBcnJheSh0aGlzLm1lbW9yeS5ibG9ja3MpO1xuICAgIHRoaXMucmVhZFZlY3RvciA9IGRlc3RpbmF0aW9uQXJyYXkgfHwgbmV3IEZsb2F0NjRBcnJheSh0aGlzLm1lbW9yeS5ibG9ja3MpO1xuXG4gICAgdGhpcy5sYXllciA9IG5ldyBMYXllci5MYXllcih0aGlzLm1lbW9yeS5ibG9ja1dpZHRoICsgdGhpcy5tZW1vcnkuYmxvY2tzICogMyArIEhlYWQuQURESVRJT05BTF9JTlBVVF9WQUxVRVMgKyB0aGlzLnNoaWZ0TGVuZ3RoKTtcblxuICAgIHRoaXMubWVtb3J5LmhpZGRlbkxheWVyLnByb2plY3QodGhpcy5sYXllciwgTGF5ZXIuTGF5ZXIuY29ubmVjdGlvblR5cGUuQUxMX1RPX0FMTCk7XG4gICAgdGhpcy5sYXllci5wcm9qZWN0KHRoaXMubWVtb3J5Lm91dHB1dExheWVyLCBMYXllci5MYXllci5jb25uZWN0aW9uVHlwZS5BTExfVE9fQUxMKTtcblxuICAgIHRoaXMuY2lyY3VsYW50TWF0cml4ID0gVXRpbHMuYnVpbGRDaXJjdWxhbnRNYXRyaXgodGhpcy5tZW1vcnkuYmxvY2tzKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZFBhcmFtcyhhY3RpdmF0aW9uOiBTeW5hcHRpYy5JTnVtZXJpY0FycmF5KSB7XG5cbiAgICB0aGlzLsOfX2tleVN0cmVuZ3RoID0gU3F1YXNoLlNPRlRQTFVTKGFjdGl2YXRpb25bMF0pO1xuICAgIHRoaXMuZ19pbnRlcnBvbGF0aW9uID0gU3F1YXNoLkxPR0lTVElDKGFjdGl2YXRpb25bMV0pO1xuICAgIHRoaXMuWV9mb2N1cyA9IE1hdGgubG9nKE1hdGguZXhwKGFjdGl2YXRpb25bMl0gKyAxKSkgKyAxOy8vU3F1YXNoLlNPRlRQTFVTKGFjdGl2YXRpb25bMl0pICsgMTtcblxuICAgIHZhciBzdGFydEF0ID0gMztcbiAgICBmb3IgKHZhciBrID0gMDsgayA8IHRoaXMua19rZXlzLmxlbmd0aDsgaysrKSB7XG4gICAgICB0aGlzLmtfa2V5c1trXSA9IHRoaXMubGF5ZXIubGlzdFtrICsgc3RhcnRBdF0uYWN0aXZhdGlvbjtcbiAgICB9XG5cbiAgICBzdGFydEF0ICs9IHRoaXMua19rZXlzLmxlbmd0aDtcbiAgICBmb3IgKHZhciBrID0gMDsgayA8IHRoaXMuYWRkR2F0ZS5sZW5ndGg7IGsrKykge1xuICAgICAgdGhpcy5hZGRHYXRlW2tdID0gdGhpcy5sYXllci5saXN0W2sgKyBzdGFydEF0XS5kZXJpdmF0aXZlO1xuICAgIH1cblxuICAgIHN0YXJ0QXQgKz0gdGhpcy5hZGRHYXRlLmxlbmd0aDtcbiAgICBmb3IgKHZhciBrID0gMDsgayA8IHRoaXMuZXJhc2VHYXRlLmxlbmd0aDsgaysrKSB7XG4gICAgICB0aGlzLmVyYXNlR2F0ZVtrXSA9IFNxdWFzaC5MT0dJU1RJQyh0aGlzLmxheWVyLmxpc3RbayArIHN0YXJ0QXRdLmFjdGl2YXRpb24pO1xuICAgIH1cblxuICAgIHN0YXJ0QXQgKz0gdGhpcy5lcmFzZUdhdGUubGVuZ3RoO1xuICAgIGZvciAodmFyIGsgPSAwOyBrIDwgdGhpcy5zaGlmdExlbmd0aDsgaysrKSB7XG4gICAgICB0aGlzLnNfc2hpZnRpbmdWZWN0b3Jba10gPSB0aGlzLmxheWVyLmxpc3RbayArIHN0YXJ0QXRdLmFjdGl2YXRpb247XG4gICAgfVxuXG4gICAgdmFyIE0gPSB0aGlzLm1lbW9yeS5kYXRhO1xuICAgIFxuICAgIC8vIGZvY3VzIGJ5IGNvbnRlbnQsIG9idGFpbnMgYW4gYXJyYXkgb2Ygc2ltaWxhcml0eSBpbmRleGVzIGZvciBlYWNoIG1lbW9yeUJsb2NrXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBNLmxlbmd0aDsgaSsrKVxuICAgICAgdGhpcy53Y19mb2N1c2VkV2VpZ2h0c1tpXSA9IFV0aWxzLmdldENvc2luZVNpbWlsYXJpdHkoTVtpXSwgdGhpcy5rX2tleXMpO1xuICAgIFxuICAgIC8vIGZvY3VzIGJ5IGxvY2F0aW9uIChpbnRlcnBvbGF0aW9uKVxuICAgIFV0aWxzLmludGVycG9sYXRlQXJyYXkodGhpcy53Y19mb2N1c2VkV2VpZ2h0cywgdGhpcy53X3dlaWdodGluZ3MsIHRoaXMuZ19pbnRlcnBvbGF0aW9uKTtcbiAgICBcbiAgICAvLyBjb252b2x1dGlvbmFsIHNoaWZ0XG4gICAgdGhpcy5kb1NoaWZ0aW5ncygpO1xuICAgICBcbiAgICAvLyBzaGFycGVuaW5nXG4gICAgVXRpbHMuc2hhcnBBcnJheSh0aGlzLndfd2VpZ2h0aW5ncywgdGhpcy53Y19mb2N1c2VkV2VpZ2h0cywgdGhpcy5ZX2ZvY3VzKTtcbiAgICBcbiAgICAvLyBzaW5jZSDiiJEgdyA9IDEsIHdlIGhhdmUgdG8gc29mdG1heCB0aGUgYXJyYXlcbiAgICBVdGlscy5zb2Z0TWF4KHRoaXMud193ZWlnaHRpbmdzKTtcbiAgICBcbiAgICAvLy8gd2UgZ290IHd0IVxuICB9XG5cbiAgZG9TaGlmdGluZ3MoKSB7XG4gICAgVXRpbHMuc29mdE1heCh0aGlzLnNfc2hpZnRpbmdWZWN0b3IpO1xuXG4gICAgVXRpbHMudmVjdG9ySW52ZXJ0ZWRTaGlmdGluZyh0aGlzLndjX2ZvY3VzZWRXZWlnaHRzLCB0aGlzLnNfc2hpZnRpbmdWZWN0b3IpO1xuICB9XG5cbiAgZG9UaW1lU3RlcCgpIHtcbiAgICB2YXIgYWN0aXZhdGlvbiA9IHRoaXMubGF5ZXIuYWN0aXZhdGUoKTtcblxuICAgIHRoaXMucmVhZFBhcmFtcyhhY3RpdmF0aW9uKTtcbiAgICBcbiAgICAvLyByZWFkaW5nXG4gICAgZm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMubWVtb3J5LmJsb2NrczsgaW5kZXgrKykge1xuICAgICAgdGhpcy5yZWFkVmVjdG9yW2luZGV4XSA9IDA7XG4gICAgICBmb3IgKHZhciBjZWxsID0gMDsgY2VsbCA8IHRoaXMubWVtb3J5LmJsb2NrV2lkdGg7IGNlbGwrKykge1xuICAgICAgICB0aGlzLnJlYWRWZWN0b3JbaW5kZXhdICs9IHRoaXMubWVtb3J5LmRhdGFbaW5kZXhdW2NlbGxdICogdGhpcy53X3dlaWdodGluZ3NbaW5kZXhdO1xuICAgICAgfVxuICAgIH1cbiAgfVxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==